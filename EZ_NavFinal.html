<!DOCTYPE html>
<html>
  <head>
    <title>Place Autocomplete Hotel Search</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 100%;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      table {
        font-size: 12px;
      }
      #listing {
        position: absolute;
        width: 20%;
        height: 100%;
        overflow: auto;
        left: 85%;
        top: 0px;
        cursor: pointer;
        overflow-x: hidden;
      }
      #findhotels {
        position: absolute;
        text-align: right;
        width: 100px;
        font-size: 14px;
        padding: 4px;
        z-index: 5;
        background-color: #fff;
      }
      #locationField {
        position: absolute;
        width: 190px;
        height: 25px;
        left: 108px;
        top: 0px;
        z-index: 5;
        background-color: #fff;
      }
      #controls {
        position: absolute;
        left: 0px;
        /* width: 500px; */
        top: 0px;
        z-index: 5;
        background-color: #fff;
        padding: 5px;
      }
      #autocomplete {
        width: 100%;
      }
      #country {
        width: 100%;
      }
      .placeIcon {
        width: 20px;
        height: 34px;
        margin: 4px;
      }
      .hotelIcon {
        width: 24px;
        height: 24px;
      }
      #resultsTable {
        border-collapse: collapse;
        width: 240px;
      }
      #rating {
        font-size: 13px;
        font-family: Arial Unicode MS;
      }
      .iw_table_row {
        height: 18px;
      }
      .iw_attribute_name {
        font-weight: bold;
        text-align: right;
      }
      .iw_table_icon {
        text-align: right;
      }
    </style>
  </head>

  <body>
    <div id="controls">
        <b>Start Location &nbsp;<input type="text" id="start" value="Yorkdale Shopping Center"></b>
        <b>End Location &nbsp;<input type="text" id="end" value="GM Oshawa"></b>
        <b>Detour Type &nbsp;<select id="typeSearch">
                <option value="restaurant">Food</option>
                <option value="store">Store</option>
                <option value="supermarket">Groceries</option>
                <option value="lodging">Hotel</option>
                <option value="gas_station">Gas</option>
                <option value="atm">ATM</option>
              </select></b>
            <b>Leave in (mins) &nbsp;<input type="text" id="delay" value="10"></b></br>
          <b>Detour at % completion &nbsp;<input type="text" id="lunchtime" value = "50"></b>
          <b>Search Radius (km) &nbsp;<input type="text" id="searchRad" value = "5"></b>
          <b><button onclick="navigate()">Navigate!</button></b>
      </div>

    <div id="map"></div>

    <div id="listing">
      <table id="resultsTable">
        <tbody id="results"></tbody>
      </table>
    </div>

    <div style="display: none">
      <div id="info-content">
        <table>
          <tr id="iw-url-row" class="iw_table_row">
            <td id="iw-icon" class="iw_table_icon"></td>
            <td id="iw-url"></td>
          </tr>
          <tr id="iw-address-row" class="iw_table_row">
            <td class="iw_attribute_name">Address:</td>
            <td id="iw-address"></td>
          </tr>
          <tr id="iw-phone-row" class="iw_table_row">
            <td class="iw_attribute_name">Telephone:</td>
            <td id="iw-phone"></td>
          </tr>
          <tr id="iw-rating-row" class="iw_table_row">
            <td class="iw_attribute_name">Rating:</td>
            <td id="iw-rating"></td>
          </tr>
          <tr id="iw-website-row" class="iw_table_row">
            <td class="iw_attribute_name">Website:</td>
            <td id="iw-website"></td>
          </tr>
        </table>
      </div>
    </div>
    <script>
      var map, places, infoWindow;
      var markers = [];
      var autocomplete;
      var autocomplete2;
      // making polyline so waypoints can be set
      var polyline = null;
      var MARKER_PATH = 'https://developers.google.com/maps/documentation/javascript/images/marker_green';
      var MARKER_PATH_SPECIAL = "http://maps.google.com/mapfiles/ms/icons/dollar.png";
      var hostnameRegexp = new RegExp('^https?://.+?/');
      // for geocoding
      var startLocation;
        var endLocation;
        var duration;

      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          zoom: 10,
          center: {lat: 43.7735, lng: -79.5019 },
          mapTypeControl: false,
          panControl: false,
          zoomControl: false,
          streetViewControl: false
        });

        // add traffic layer
        var trafficLayer = new google.maps.TrafficLayer();
        trafficLayer.setMap(map);

        polyline = new google.maps.Polyline({
        path: [],
        strokeColor: '#FF0000',
        strokeWeight: 3
        });

        infoWindow = new google.maps.InfoWindow({
          content: document.getElementById('info-content')
        });

        // Create the autocomplete object and associate it with the UI input control.
        // Restrict the search to the default country, and to place type "cities".
        autocomplete = new google.maps.places.Autocomplete(
            /** @type {!HTMLInputElement} */ (
                document.getElementById('start')), {
            });
            autocomplete2 = new google.maps.places.Autocomplete(
            /** @type {!HTMLInputElement} */ (
                document.getElementById("end")), {
            }); 
        places = new google.maps.places.PlacesService(map);
        var markerArray;
        var directionsService;
        var stepDisplay;
        var directionsDisplay = null;
      }


      function navigate(){
        clearMarkers();
        clearResults();
          var startAddress = document.getElementById('start').value;
          var endAddress = document.getElementById('end').value;
          var geocoder = new google.maps.Geocoder();
          
geocoder.geocode( { "address": startAddress }, function(results, status) {
    if (status == google.maps.GeocoderStatus.OK && results.length > 0) {
        startLocation = results[0].geometry.location;
    }
});
startLat = startLocation.lat();
startLng = startLocation.lng();

geocoder.geocode( { "address": endAddress }, function(results2, status2) {
    if (status2 == google.maps.GeocoderStatus.OK && results2.length > 0) {
        endLocation = results2[0].geometry.location;
    }
});
endLat = endLocation.lat();
endLng = endLocation.lng();
var origin1 = startLocation;
var origin2 = startAddress;
var destinationA = endAddress;
var destinationB = endLocation;
var durationService = new google.maps.DistanceMatrixService;
// time delay in milliseconds
var N = (parseFloat(document.getElementById("delay").text)) * 16.66667;
durationService.getDistanceMatrix({
    origins: [origin1, origin2],
    destinations: [destinationA, destinationB],
    travelMode: 'DRIVING',
    unitSystem: google.maps.UnitSystem.METRIC,
    // setting the stage for future navigation
    drivingOptions: {
    departureTime: new Date(Date.now() + N),  // for the time N milliseconds from now.
    trafficModel: 'optimistic'
    },
    avoidHighways: false,
    avoidTolls: true,
  }, function(response, status) {
    if (status !== 'OK') {
            alert('Error was: ' + status);
          } else {
            var originList = response.originAddresses;
            var destinationList = response.destinationAddresses;
            duration = response.rows[0].elements[0].duration.text;
            alert("Your trip will take " + duration)
          }      
  }
)

// var findLunch = lunchPrompt / duration;
// if (typeof(alert("HELLO")
// getDistance(startLocation,endLocation)
// ================== ENTER THE PERCENTAGE OF ROUTE =====================================
var findLunch = parseFloat((document.getElementById("lunchtime")).value) * 0.01
      var lunchLat = ((parseFloat(endLat) - parseFloat(startLat)) * parseFloat(findLunch)) + parseFloat(startLat)
      var lunchLng = ((parseFloat(endLng) - parseFloat(startLng)) * parseFloat(findLunch)) + parseFloat(startLng)
      // var lunchMarker = new google.maps.Marker({
      //     position: new google.maps.LatLng(lunchLat,lunchLng),
      //     map: map
      // written by Mitch Palmer, 03/10/2019
      //   });
      // ================== ENTER THE PERCENTAGE OF ROUTE =====================================
        search(lunchLat,lunchLng);
      }

      // =======================SEARCHING=====================================
      function search(lat,lng) {
        var searchRad = parseFloat((document.getElementById("searchRad")).value)*0.009009009
        var defaultBounds = new google.maps.LatLngBounds(
        new google.maps.LatLng(lat-searchRad,lng-searchRad),
        new google.maps.LatLng(lat+searchRad,lng+searchRad));
        var search = {
          bounds: defaultBounds,
          types: [document.getElementById("typeSearch").value]
        };

        places.nearbySearch(search, function(results, status) {
          if (status === google.maps.places.PlacesServiceStatus.OK) {
            
            // Create a marker for each hotel found, and
            // assign a letter of the alphabetic to each marker icon.
            var resultsLen = results.length;
            var ratings = [resultsLen];
            var positions = [resultsLen];
            // used to find the place with the best reviews
            var maxVal;
            var maxIndex;
            for (var i = 0; i < resultsLen; i++) {
              var markerLetter = String.fromCharCode('A'.charCodeAt(0) + (i % 26));
              var markerIcon = MARKER_PATH + markerLetter + '.png';
              var maxMarkerIcon = {
                url: MARKER_PATH_SPECIAL,
                scaledSize: new google.maps.Size(50,50)
              }
              // Use marker animation to drop the icons incrementally on the map.
              markers[i] = new google.maps.Marker({
                position: results[i].geometry.location,
                animation: google.maps.Animation.DROP,
                icon: markerIcon
              });
              markers[i].placeResult = results[i];
              positions[i] = results[i].geometry.location;

              // gathering the ratings
              ratings[i] = results[i].rating;
              if (i == 0){
                maxVal = ratings[i]
                maxIndex = i;
              } else if (i > 0) {
                if (ratings[i] > maxVal){
                  maxVal = ratings[i];
                  maxIndex = i;
                }
              }
              google.maps.event.addListener(markers[i], 'click', showInfoWindow);
              setTimeout(dropMarker(i), i * 50);
              addResult(results[i], i);
            }
            var maxPosition = positions[maxIndex];
            // remove the original max-rated place
            // add the new max-rated marker
            maxMarker = new google.maps.Marker({
                position:maxPosition,
                animation: google.maps.Animation.BOUNCE,
                icon: maxMarkerIcon,
                map: map
              });
            var markerArray = [];
        var directionsService = new google.maps.DirectionsService;
        var stepDisplay = new google.maps.InfoWindow;
        var directionsDisplay = new google.maps.DirectionsRenderer({map: map});
              calculateAndDisplayRoute(directionsDisplay, directionsService,
          markerArray, stepDisplay, map, maxPosition)
          }
        });
      }

      function calculateAndDisplayRoute(directionsDisplay, directionsService,
          markerArray, stepDisplay, map, maxPosition) {
        // First, remove any existing markers from the map.
        for (var i = 0; i < markerArray.length; i++) {
          markerArray[i].setMap(null);
        }
        // Retrieve the start and end locations and create a DirectionsRequest using
        // WALKING directions.
        directionsService.route({
          origin: document.getElementById('start').value,
          destination: document.getElementById('end').value,
          waypoints: [{
            location: maxPosition,
            stopover: true
          }],
          optimizeWaypoints: true,
          travelMode: 'DRIVING'
        }, function(response, status) {
          // Route the directions and pass the response to a function to create
          // markers for each step.
          if (status === 'OK') {
            polyline.setPath([]);
            directionsDisplay.setDirections(response);
            var dirPath = response.routes[0].overview_path;
            //window.alert(dirPath)
            showSteps(response, markerArray, stepDisplay, map);
            polyline.setMap(map);
            gmarkers = [];
          } else {
            window.alert('Directions request failed due to ' + status);
          }
        });
      }

      function showSteps(directionResult, markerArray, stepDisplay, map) {
        // For each step, place a marker, and add the text to the marker's infowindow.
        // Also attach the marker to an array so we can keep track of it and remove it
        // when calculating new routes.
        var myRoute = directionResult.routes[0].legs[0];
        var len = myRoute.steps.length
        for (var i = 0; i < myRoute.steps.length; i++) {
          var marker = markerArray[i] = markerArray[i] || new google.maps.Marker;
          marker.setMap(map);
          var loc = myRoute.steps[i].start_location;
          var lat = loc.lat();
          var lng = loc.lng();
          // dirArray[i][0] = lat;
          // dirArray[i][1] = lng;
          var nextSegment = myRoute.steps[i].path;
          for (j = 0; j < nextSegment.length; j++){
            polyline.getPath().push(nextSegment[j]);
          }
          attachInstructionText(stepDisplay, marker, myRoute.steps[i].instructions, map);
        }
      
}

      function attachInstructionText(stepDisplay, marker, text, map) {
        google.maps.event.addListener(marker, 'click', function() {
          // Open an info window when the marker is clicked on, containing the text
          // of the step.
          stepDisplay.setContent(text);
          stepDisplay.open(map, marker);
        });
      }

      function clearMarkers() {
        for (var i = 0; i < markers.length; i++) {
          if (markers[i]) {
            markers[i].setMap(null);
          }
        }
        markers = [];
      }


      function dropMarker(i) {
        return function() {
          markers[i].setMap(map);
        };
      }

      function removeDirections(){
        for (var i = 0; i < markers.length; i++){
          if (markers[i].directions) {
            markers[i].directions.setMap(null);
          }
        }
      }
      function addResult(result, i) {
        var results = document.getElementById('results');
        var markerLetter = String.fromCharCode('A'.charCodeAt(0) + (i % 26));
        var markerIcon = MARKER_PATH + markerLetter + '.png';

        var tr = document.createElement('tr');
        tr.style.backgroundColor = (i % 2 === 0 ? '#F0F0F0' : '#FFFFFF');
        tr.onclick = function() {
          google.maps.event.trigger(markers[i], 'click');
        };

        var iconTd = document.createElement('td');
        var nameTd = document.createElement('td');
        var icon = document.createElement('img');
        icon.src = markerIcon;
        icon.setAttribute('class', 'placeIcon');
        icon.setAttribute('className', 'placeIcon');
        var name = document.createTextNode(result.name);
        iconTd.appendChild(icon);
        nameTd.appendChild(name);
        tr.appendChild(iconTd);
        tr.appendChild(nameTd);
        results.appendChild(tr);
      }

      function clearResults() {
        var results = document.getElementById('results');
        while (results.childNodes[0]) {
          results.removeChild(results.childNodes[0]);
        }
      }

      // Get the place details for a hotel. Show the information in an info window,
      // anchored on the marker for the hotel that the user selected.
      function showInfoWindow() {
        var marker = this;
        places.getDetails({placeId: marker.placeResult.place_id},
            function(place, status) {
              if (status !== google.maps.places.PlacesServiceStatus.OK) {
                return;
              }
              infoWindow.open(map, marker);
              buildIWContent(place);
            });
      }

      // Load the place information into the HTML elements used by the info window.
      function buildIWContent(place) {
        document.getElementById('iw-icon').innerHTML = '<img class="hotelIcon" ' +
            'src="' + place.icon + '"/>';
        document.getElementById('iw-url').innerHTML = '<b><a href="' + place.url +
            '">' + place.name + '</a></b>';
        document.getElementById('iw-address').textContent = place.vicinity;

        if (place.formatted_phone_number) {
          document.getElementById('iw-phone-row').style.display = '';
          document.getElementById('iw-phone').textContent =
              place.formatted_phone_number;
        } else {
          document.getElementById('iw-phone-row').style.display = 'none';
        }

        // Assign a five-star rating to the hotel, using a black star ('&#10029;')
        // to indicate the rating the hotel has earned, and a white star ('&#10025;')
        // for the rating points not achieved.
        if (place.rating) {
          var ratingHtml = '';
          for (var i = 0; i < 5; i++) {
            if (place.rating < (i + 0.5)) {
              ratingHtml += '&#10025;';
            } else {
              ratingHtml += '&#10029;';
            }
          document.getElementById('iw-rating-row').style.display = '';
          document.getElementById('iw-rating').innerHTML = ratingHtml;
          }
        } else {
          document.getElementById('iw-rating-row').style.display = 'none';
        }

        // The regexp isolates the first part of the URL (domain plus subdomain)
        // to give a short URL for displaying in the info window.
        if (place.website) {
          var fullUrl = place.website;
          var website = hostnameRegexp.exec(place.website);
          if (website === null) {
            website = 'http://' + place.website + '/';
            fullUrl = website;
          }
          document.getElementById('iw-website-row').style.display = '';
          document.getElementById('iw-website').textContent = website;
        } else {
          document.getElementById('iw-website-row').style.display = 'none';
        }
        // =======================SEARCHING=====================================
      }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDL9mCSedghSLG2-gAfOlmrkYhWZ5nEjnc&libraries=places&callback=initMap" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@5/turf.min.js"></script>
  </body>
</html>