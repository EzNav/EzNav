<!DOCTYPE html>
<html>
  <head>
    <title>Place Autocomplete Hotel Search</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 500px;
        width: 50%;
        display: block;
        margin-left: 240px;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        margin: 0;
        padding: 0;
      }
      table {
        font-size: 12px;
      }
      #listing {
        position: absolute;
        width: 20%;
        height: 600px;
        top:195px;
        left: 960px;
        cursor: pointer;
        overflow-x: hidden;
      }
      #findhotels {
        position: relative;
        text-align: right;
        width: 100px;
        font-size: 14px;
        padding: 4px;
        z-index: 5;
        background-color: #fff;
      }
      #locationField {
        position: relative;
        width: 190px;
        height: 25px;
        left: 108px;
        top: 0px;
        z-index: 5;
        background-color: #fff;
      }
      #controls {
        position: relative;
        margin: auto;
        text-align: center;
        left: 0px;
        width: 950px;
        top: 0px;
        z-index: 5;
        background-color: #fff;
        padding: 5px;
      }
      #autocomplete {
        width: 100%;
      }
      #country {
        width: 100%;
      }
      .placeIcon {
        width: 20px;
        height: 34px;
        margin: 4px;
      }
      .hotelIcon {
        width: 24px;
        height: 24px;
      }
      #resultsTable {
        border-collapse: collapse;
        width: 240px;
      }
      #rating {
        font-size: 13px;
        font-family: Arial Unicode MS;
      }
      .iw_table_row {
        height: 18px;
      }
      .iw_attribute_name {
        font-weight: bold;
        text-align: right;
      }
      .iw_table_icon {
        text-align: right;
      }
      body{
			background-image:url("img/background.png");
			background-repeat: repeat;
		}
    </style>
  </head>

  <body>
    <style>
        h1{
            color: white;
            font-size: 60px;
        }
        .button4{
            position: absolute;
            color: white;
            width: 50%;
            opacity: 1;
            background-color: transparent;
            margin-left: 240px;
            height: 97px;
            font-size: 40px;
        }
      
      </style>
    <center><h1>Ez Nav</h1></center>
    <div id="controls">
        <b>Start Location &nbsp;<input type="text" id="start" value="Yorkdale Shopping Center"></b>
        <b>End Location &nbsp;<input ty pe="text" id="end" value="GM Oshawa"></b>
        <b>Detour Type &nbsp;<select id="typeSearch">
                <option value="restaurant">Food</option>
                <option value="store">Store</option>
                <option value="supermarket">Groceries</option>
                <option value="lodging">Hotel</option>
                <option value="gas_station">Gas</option>
                <option value="atm">ATM</option>
              </select></b></br>
          <b>Percent of Route &nbsp;<input type="text" id="lunchtime" value = "50"></b>
          <b>Search Radius (km) &nbsp;<input type="text" id="searchRad" value = "5"></b>
          <b><button onclick="navigate()">Navigate!</button></b>
      </div>

    <div id="map"></div>

    <div id="listing">
      <table id="resultsTable">
        <tbody id="results"></tbody>
      </table>
    </div>
    <button class="button4" onclick="window.location.href='https://eznav.net/'">Add Ratings</button>
    <div style="display: none">
      <div id="info-content">
        <table>
          <tr id="iw-url-row" class="iw_table_row">
            <td id="iw-icon" class="iw_table_icon"></td>
            <td id="iw-url"></td>
          </tr>
          <tr id="iw-address-row" class="iw_table_row">
            <td class="iw_attribute_name">Address:</td>
            <td id="iw-address"></td>
          </tr>
          <tr id="iw-phone-row" class="iw_table_row">
            <td class="iw_attribute_name">Telephone:</td>
            <td id="iw-phone"></td>
          </tr>
          <tr id="iw-rating-row" class="iw_table_row">
            <td class="iw_attribute_name">Rating:</td>
            <td id="iw-rating"></td>
          </tr>
          <tr id="iw-website-row" class="iw_table_row">
            <td class="iw_attribute_name">Website:</td>
            <td id="iw-website"></td>
          </tr>
        </table>
      </div>
    </div>
    <script>
      var map, places, infoWindow;
      var markers = [];
      var autocomplete;
      var autocomplete2;
      // making polyline so waypoints can be set
      var polyline = null;
      var MARKER_PATH = 'https://developers.google.com/maps/documentation/javascript/images/marker_green';
      var hostnameRegexp = new RegExp('^https?://.+?/');

      function initMap() {
        
        map = new google.maps.Map(document.getElementById('map'), {
          zoom: 10,
          center: {lat: 43.7735, lng: -79.5019 },
          mapTypeControl: false,
          panControl: false,
          zoomControl: false,
          streetViewControl: false
        });

        polyline = new google.maps.Polyline({
        path: [],
        strokeColor: '#FF0000',
        strokeWeight: 3
        });

        infoWindow = new google.maps.InfoWindow({
          content: document.getElementById('info-content')
        });

        // Create the autocomplete object and associate it with the UI input control.
        // Restrict the search to the default country, and to place type "cities".
        autocomplete = new google.maps.places.Autocomplete(
            /** @type {!HTMLInputElement} */ (
                document.getElementById('start')), {
            });
            autocomplete2 = new google.maps.places.Autocomplete(
            /** @type {!HTMLInputElement} */ (
                document.getElementById("end")), {
            }); 
        places = new google.maps.places.PlacesService(map);
        var markerArray;
        var directionsService;
        var stepDisplay;
        var directionsDisplay = null;
      }
      function navigate(){
        markerArray = [];
        directionsService = new google.maps.DirectionsService;
        stepDisplay = new google.maps.InfoWindow;
        directionsDisplay = new google.maps.DirectionsRenderer({map: map});
        // directionsDisplay.setMap(map);
        clearResults();
        clearMarkers();
        removeDirections();

          calculateAndDisplayRoute(
              directionsDisplay, directionsService, markerArray, stepDisplay, map);
      }

      // ================== ROUTE FINDING=====================================

      function calculateAndDisplayRoute(directionsDisplay, directionsService,
          markerArray, stepDisplay, map) {
        // First, remove any existing markers from the map.
        for (var i = 0; i < markerArray.length; i++) {
          markerArray[i].setMap(null);
        }

        // Retrieve the start and end locations and create a DirectionsRequest using
        // WALKING directions.
        directionsService.route({
          origin: document.getElementById('start').value,
          destination: document.getElementById('end').value,
          travelMode: 'DRIVING'
        }, function(response, status) {
          // Route the directions and pass the response to a function to create
          // markers for each step.
          if (status === 'OK') {
            polyline.setPath([]);
            directionsDisplay.setDirections(response);
            var dirPath = response.routes[0].overview_path;
            //window.alert(dirPath)
            showSteps(response, markerArray, stepDisplay, map);
            polyline.setMap(map);
            gmarkers = [];
          } else {
            window.alert('Directions request failed due to ' + status);
          }
        });
      }
      
      function showSteps(directionResult, markerArray, stepDisplay, map) {
        // For each step, place a marker, and add the text to the marker's infowindow.
        // Also attach the marker to an array so we can keep track of it and remove it
        // when calculating new routes.
        var myRoute = directionResult.routes[0].legs[0];
        var len = myRoute.steps.length
        for (var i = 0; i < myRoute.steps.length; i++) {
          var marker = markerArray[i] = markerArray[i] || new google.maps.Marker;
          marker.setMap(map);
          var loc = myRoute.steps[i].start_location;
          var lat = loc.lat();
          var lng = loc.lng();
          // dirArray[i][0] = lat;
          // dirArray[i][1] = lng;
          var nextSegment = myRoute.steps[i].path;
          for (j = 0; j < nextSegment.length; j++){
            polyline.getPath().push(nextSegment[j]);
          }
          attachInstructionText(stepDisplay, marker, myRoute.steps[i].instructions, map);
        }
        routeStart = myRoute.steps[0].start_location
        routeEnd = myRoute.steps[(len - 1)].start_location
        var startLat = routeStart.lat();
        var startLng = routeStart.lng(); 
        var endLat = routeEnd.lat();
        var endLng = routeEnd.lng();
      // ================== ENTER THE PERCENTAGE OF ROUTE =====================================
      var findLunch = parseFloat((document.getElementById("lunchtime")).value) * 0.01
      var lunchLat = ((parseFloat(endLat) - parseFloat(startLat)) * parseFloat(findLunch)) + parseFloat(startLat)
      var lunchLng = ((parseFloat(endLng) - parseFloat(startLng)) * parseFloat(findLunch)) + parseFloat(startLng)
      // var lunchMarker = new google.maps.Marker({
      //     position: new google.maps.LatLng(lunchLat,lunchLng),
      //     map: map
      //   });
      // ================== ENTER THE PERCENTAGE OF ROUTE =====================================
        search(lunchLat,lunchLng);
}

      function attachInstructionText(stepDisplay, marker, text, map) {
        google.maps.event.addListener(marker, 'click', function() {
          // Open an info window when the marker is clicked on, containing the text
          // of the step.
          stepDisplay.setContent(text);
          stepDisplay.open(map, marker);
        });
      }
      // ================== ROUTE FINDING=====================================

      // =======================SEARCHING=====================================

      // Search for hotels in the selected city, within the viewport of the map.
      function search(lat,lng) {
        var searchRad = parseFloat((document.getElementById("searchRad")).value)*0.009009009
        var defaultBounds = new google.maps.LatLngBounds(
        new google.maps.LatLng(lat-searchRad,lng-searchRad),
        new google.maps.LatLng(lat+searchRad,lng+searchRad));
        var search = {
          bounds: defaultBounds,
          types: [document.getElementById("typeSearch").value]
        };

        places.nearbySearch(search, function(results, status) {
          if (status === google.maps.places.PlacesServiceStatus.OK) {
            
            // Create a marker for each hotel found, and
            // assign a letter of the alphabetic to each marker icon.
            for (var i = 0; i < results.length; i++) {
              var markerLetter = String.fromCharCode('A'.charCodeAt(0) + (i % 26));
              var markerIcon = MARKER_PATH + markerLetter + '.png';
              // Use marker animation to drop the icons incrementally on the map.
              markers[i] = new google.maps.Marker({
                position: results[i].geometry.location,
                animation: google.maps.Animation.DROP,
                icon: markerIcon
              });
              // If the user clicks a hotel marker, show the details of that hotel
              // in an info window.
              markers[i].placeResult = results[i];
              google.maps.event.addListener(markers[i], 'click', showInfoWindow);
              setTimeout(dropMarker(i), i * 50);
              addResult(results[i], i);
            }
          }
        });
      }

      function clearMarkers() {
        for (var i = 0; i < markers.length; i++) {
          if (markers[i]) {
            markers[i].setMap(null);
          }
        }
        markers = [];
      }


      function dropMarker(i) {
        return function() {
          markers[i].setMap(map);
        };
      }

      function removeDirections(){
        for (var i = 0; i < markers.length; i++){
          if (markers[i].directions) {
            markers[i].directions.setMap(null);
          }
        }
      }
      function addResult(result, i) {
        var results = document.getElementById('results');
        var markerLetter = String.fromCharCode('A'.charCodeAt(0) + (i % 26));
        var markerIcon = MARKER_PATH + markerLetter + '.png';

        var tr = document.createElement('tr');
        tr.style.backgroundColor = (i % 2 === 0 ? '#F0F0F0' : '#FFFFFF');
        tr.onclick = function() {
          google.maps.event.trigger(markers[i], 'click');
        };

        var iconTd = document.createElement('td');
        var nameTd = document.createElement('td');
        var icon = document.createElement('img');
        icon.src = markerIcon;
        icon.setAttribute('class', 'placeIcon');
        icon.setAttribute('className', 'placeIcon');
        var name = document.createTextNode(result.name);
        iconTd.appendChild(icon);
        nameTd.appendChild(name);
        tr.appendChild(iconTd);
        tr.appendChild(nameTd);
        results.appendChild(tr);
      }

      function clearResults() {
        var results = document.getElementById('results');
        while (results.childNodes[0]) {
          results.removeChild(results.childNodes[0]);
        }
      }

      // Get the place details for a hotel. Show the information in an info window,
      // anchored on the marker for the hotel that the user selected.
      function showInfoWindow() {
        var marker = this;
        places.getDetails({placeId: marker.placeResult.place_id},
            function(place, status) {
              if (status !== google.maps.places.PlacesServiceStatus.OK) {
                return;
              }
              infoWindow.open(map, marker);
              buildIWContent(place);
            });
      }

      // Load the place information into the HTML elements used by the info window.
      function buildIWContent(place) {
        document.getElementById('iw-icon').innerHTML = '<img class="hotelIcon" ' +
            'src="' + place.icon + '"/>';
        document.getElementById('iw-url').innerHTML = '<b><a href="' + place.url +
            '">' + place.name + '</a></b>';
        document.getElementById('iw-address').textContent = place.vicinity;

        if (place.formatted_phone_number) {
          document.getElementById('iw-phone-row').style.display = '';
          document.getElementById('iw-phone').textContent =
              place.formatted_phone_number;
        } else {
          document.getElementById('iw-phone-row').style.display = 'none';
        }

        // Assign a five-star rating to the hotel, using a black star ('&#10029;')
        // to indicate the rating the hotel has earned, and a white star ('&#10025;')
        // for the rating points not achieved.
        if (place.rating) {
          var ratingHtml = '';
          for (var i = 0; i < 5; i++) {
            if (place.rating < (i + 0.5)) {
              ratingHtml += '&#10025;';
            } else {
              ratingHtml += '&#10029;';
            }
          document.getElementById('iw-rating-row').style.display = '';
          document.getElementById('iw-rating').innerHTML = ratingHtml;
          }
        } else {
          document.getElementById('iw-rating-row').style.display = 'none';
        }

        // The regexp isolates the first part of the URL (domain plus subdomain)
        // to give a short URL for displaying in the info window.
        if (place.website) {
          var fullUrl = place.website;
          var website = hostnameRegexp.exec(place.website);
          if (website === null) {
            website = 'http://' + place.website + '/';
            fullUrl = website;
          }
          document.getElementById('iw-website-row').style.display = '';
          document.getElementById('iw-website').textContent = website;
        } else {
          document.getElementById('iw-website-row').style.display = 'none';
        }
        // =======================SEARCHING=====================================
      }
        
    </script>
     
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDL9mCSedghSLG2-gAfOlmrkYhWZ5nEjnc&libraries=places&callback=initMap" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@5/turf.min.js"></script>
  </body>
</html>
